<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `registry` mod in crate `cargo`."><meta name="keywords" content="rust, rustlang, rust-lang, registry"><title>cargo::sources::registry - Rust</title><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled ><script src="../../../storage.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../../../favicon.svg">
<link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../../cargo/index.html'><div class='logo-container rust-logo'><img src='../../../rust-logo.png' alt='logo'></div></a><p class='location'>Module registry</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#traits">Traits</a></li></ul></div><p class='location'><a href='../../index.html'>cargo</a>::<wbr><a href='../index.html'>sources</a></p><script>window.sidebarCurrent = {name: 'registry', ty: 'mod', relpath: '../'};</script><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><span class="help-button">?</span>
                <a id="settings-menu" href="../../../settings.html"><img src="../../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../../src/cargo/sources/registry/mod.rs.html#1-656' title='goto source code'>[src]</a></span><span class='in-band'>Module <a href='../../index.html'>cargo</a>::<wbr><a href='../index.html'>sources</a>::<wbr><a class="mod" href=''>registry</a></span></h1><div class='docblock'><p>A <code>Source</code> for registry-based packages.</p>
<h1 id="whats-a-registry" class="section-header"><a href="#whats-a-registry">What's a Registry?</a></h1>
<p>Registries are central locations where packages can be uploaded to,
discovered, and searched for. The purpose of a registry is to have a
location that serves as permanent storage for versions of a crate over time.</p>
<p>Compared to git sources, a registry provides many packages as well as many
versions simultaneously. Git sources can also have commits deleted through
rebasings where registries cannot have their versions deleted.</p>
<h1 id="the-index-of-a-registry" class="section-header"><a href="#the-index-of-a-registry">The Index of a Registry</a></h1>
<p>One of the major difficulties with a registry is that hosting so many
packages may quickly run into performance problems when dealing with
dependency graphs. It's infeasible for cargo to download the entire contents
of the registry just to resolve one package's dependencies, for example. As
a result, cargo needs some efficient method of querying what packages are
available on a registry, what versions are available, and what the
dependencies for each version is.</p>
<p>One method of doing so would be having the registry expose an HTTP endpoint
which can be queried with a list of packages and a response of their
dependencies and versions is returned. This is somewhat inefficient however
as we may have to hit the endpoint many times and we may have already
queried for much of the data locally already (for other packages, for
example). This also involves inventing a transport format between the
registry and Cargo itself, so this route was not taken.</p>
<p>Instead, Cargo communicates with registries through a git repository
referred to as the Index. The Index of a registry is essentially an easily
query-able version of the registry's database for a list of versions of a
package as well as a list of dependencies for each version.</p>
<p>Using git to host this index provides a number of benefits:</p>
<ul>
<li>
<p>The entire index can be stored efficiently locally on disk. This means
that all queries of a registry can happen locally and don't need to touch
the network.</p>
</li>
<li>
<p>Updates of the index are quite efficient. Using git buys incremental
updates, compressed transmission, etc for free. The index must be updated
each time we need fresh information from a registry, but this is one
update of a git repository that probably hasn't changed a whole lot so
it shouldn't be too expensive.</p>
<p>Additionally, each modification to the index is just appending a line at
the end of a file (the exact format is described later). This means that
the commits for an index are quite small and easily applied/compressible.</p>
</li>
</ul>
<h2 id="the-format-of-the-index" class="section-header"><a href="#the-format-of-the-index">The format of the Index</a></h2>
<p>The index is a store for the list of versions for all packages known, so its
format on disk is optimized slightly to ensure that <code>ls registry</code> doesn't
produce a list of all packages ever known. The index also wants to ensure
that there's not a million files which may actually end up hitting
filesystem limits at some point. To this end, a few decisions were made
about the format of the registry:</p>
<ol>
<li>Each crate will have one file corresponding to it. Each version for a
crate will just be a line in this file.</li>
<li>There will be two tiers of directories for crate names, under which
crates corresponding to those tiers will be located.</li>
</ol>
<p>As an example, this is an example hierarchy of an index:</p>
<pre><code class="language-notrust">.
├── 3
│   └── u
│       └── url
├── bz
│   └── ip
│       └── bzip2
├── config.json
├── en
│   └── co
│       └── encoding
└── li
    ├── bg
    │   └── libgit2
    └── nk
        └── link-config
</code></pre>
<p>The root of the index contains a <code>config.json</code> file with a few entries
corresponding to the registry (see <code>RegistryConfig</code> below).</p>
<p>Otherwise, there are three numbered directories (1, 2, 3) for crates with
names 1, 2, and 3 characters in length. The 1/2 directories simply have the
crate files underneath them, while the 3 directory is sharded by the first
letter of the crate name.</p>
<p>Otherwise the top-level directory contains many two-letter directory names,
each of which has many sub-folders with two letters. At the end of all these
are the actual crate files themselves.</p>
<p>The purpose of this layout is to hopefully cut down on <code>ls</code> sizes as well as
efficient lookup based on the crate name itself.</p>
<h2 id="crate-files" class="section-header"><a href="#crate-files">Crate files</a></h2>
<p>Each file in the index is the history of one crate over time. Each line in
the file corresponds to one version of a crate, stored in JSON format (see
the <code>RegistryPackage</code> structure below).</p>
<p>As new versions are published, new lines are appended to this file. The only
modifications to this file that should happen over time are yanks of a
particular version.</p>
<h1 id="downloading-packages" class="section-header"><a href="#downloading-packages">Downloading Packages</a></h1>
<p>The purpose of the Index was to provide an efficient method to resolve the
dependency graph for a package. So far we only required one network
interaction to update the registry's repository (yay!). After resolution has
been performed, however we need to download the contents of packages so we
can read the full manifest and build the source code.</p>
<p>To accomplish this, this source's <code>download</code> method will make an HTTP
request per-package requested to download tarballs into a local cache. These
tarballs will then be unpacked into a destination folder.</p>
<p>Note that because versions uploaded to the registry are frozen forever that
the HTTP download and unpacking can all be skipped if the version has
already been downloaded and unpacked. This caching allows us to only
download a package when absolutely necessary.</p>
<h1 id="filesystem-hierarchy" class="section-header"><a href="#filesystem-hierarchy">Filesystem Hierarchy</a></h1>
<p>Overall, the <code>$HOME/.cargo</code> looks like this when talking about the registry:</p>
<pre><code class="language-notrust"># A folder under which all registry metadata is hosted (similar to
# $HOME/.cargo/git)
$HOME/.cargo/registry/

    # For each registry that cargo knows about (keyed by hostname + hash)
    # there is a folder which is the checked out version of the index for
    # the registry in this location. Note that this is done so cargo can
    # support multiple registries simultaneously
    index/
        registry1-&lt;hash&gt;/
        registry2-&lt;hash&gt;/
        ...

    # This folder is a cache for all downloaded tarballs from a registry.
    # Once downloaded and verified, a tarball never changes.
    cache/
        registry1-&lt;hash&gt;/&lt;pkg&gt;-&lt;version&gt;.crate
        ...

    # Location in which all tarballs are unpacked. Each tarball is known to
    # be frozen after downloading, so transitively this folder is also
    # frozen once its unpacked (it's never unpacked again)
    src/
        registry1-&lt;hash&gt;/&lt;pkg&gt;-&lt;version&gt;/...
        ...
</code></pre>
</div><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.RegistryConfig.html" title='cargo::sources::registry::RegistryConfig struct'>RegistryConfig</a></td><td class='docblock-short'></td></tr><tr class='module-item'><td><a class="struct" href="struct.RegistryPackage.html" title='cargo::sources::registry::RegistryPackage struct'>RegistryPackage</a></td><td class='docblock-short'><p>A single line in the index representing a single version of a package.</p>
</td></tr><tr class='module-item'><td><a class="struct" href="struct.RegistrySource.html" title='cargo::sources::registry::RegistrySource struct'>RegistrySource</a></td><td class='docblock-short'></td></tr></table><h2 id='enums' class='section-header'><a href="#enums">Enums</a></h2>
<table><tr class='module-item'><td><a class="enum" href="enum.MaybeLock.html" title='cargo::sources::registry::MaybeLock enum'>MaybeLock</a></td><td class='docblock-short'></td></tr></table><h2 id='constants' class='section-header'><a href="#constants">Constants</a></h2>
<table><tr class='module-item'><td><a class="constant" href="constant.CRATES_IO_INDEX.html" title='cargo::sources::registry::CRATES_IO_INDEX constant'>CRATES_IO_INDEX</a></td><td class='docblock-short'></td></tr><tr class='module-item'><td><a class="constant" href="constant.CRATES_IO_REGISTRY.html" title='cargo::sources::registry::CRATES_IO_REGISTRY constant'>CRATES_IO_REGISTRY</a></td><td class='docblock-short'></td></tr></table><h2 id='traits' class='section-header'><a href="#traits">Traits</a></h2>
<table><tr class='module-item'><td><a class="trait" href="trait.RegistryData.html" title='cargo::sources::registry::RegistryData trait'>RegistryData</a></td><td class='docblock-short'></td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../../";window.currentCrate = "cargo";</script><script src="../../../main.js"></script><script defer src="../../../search-index.js"></script></body></html>